<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš¬ ìŠ¤ë§ˆíŠ¸ ê¸ˆì—° ë„ìš°ë¯¸ ğŸš­</title>
    <style>
        /* (ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e0f7fa; /* Light Teal Background */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align items to the top */
            min-height: 100vh; /* Ensure full viewport height */
        }

        h1 {
            text-align: center;
            color: #263238; /* Dark Blue Gray */
            margin-top: 20px;
            margin-bottom: 20px;
        }

        #container {
            position: relative;
            width: 640px;
            height: 480px;
            border: 2px solid #b2ebf2; /* Light Teal Border */
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Subtle shadow */
            border-radius: 8px;
            overflow: hidden; /* Clip canvas overflow */
        }

        #webcam {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            pointer-events: none;
        }

        #log-container { /* Container for log and sound control */
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align items to the top within the container */
            width: 640px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        #log {
            padding: 15px;
            width: 480px; /* Adjusted width for log */
            max-height: 200px;
            overflow-y: auto;
            background-color: #37474f; /* Dark Gray for Log */
            color: #eceff1; /* Light Gray for Log Text */
            font-family: monospace;
            border-radius: 8px;
            border: 1px solid #546e7a; /* Medium Gray Border */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            font-size: 14px;
            line-height: 1.4;
        }

        #sound-control { /* Sound control area */
            width: 140px; /* Adjusted width for sound control */
            padding: 15px;
            background-color: #fff;
            border: 1px solid #b2ebf2;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }

        #sound-control button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: #00bcd4; /* Teal Button */
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        #sound-control button:hover {
            background-color: #00acc1; /* Darker Teal on Hover */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 20px;
            }
            #container, #log-container, #log {
                width: 95%; /* Make container and log responsive */
                max-width: 640px; /* Limit max width */
            }
            #log-container {
                flex-direction: column; /* Stack log and sound control on smaller screens */
                align-items: stretch; /* Stretch items to full width */
            }
            #log, #sound-control {
                width: 100%; /* Full width for log and sound control */
                margin-bottom: 10px; /* Add spacing between stacked items */
            }
        }
    </style>
</head>
<body>
    <h1>ğŸš¬ ìŠ¤ë§ˆíŠ¸ ê¸ˆì—° ë„ìš°ë¯¸ ğŸš­</h1>
    <div id="container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="canvas" width="640" height="480"></canvas>
    </div>
    <div id="log-container">
        <div id="log"></div>
        <div id="sound-control">
            <button id="toggleSound">ì†Œë¦¬ ì•Œë¦¼ ì¼œê¸°/ë„ê¸°</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.0/dist/ort.min.js"></script>
    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let alertSound = new Audio('alert_sound.mp3'); // ğŸš¨ ì•Œë¦¼ ì†Œë¦¬ íŒŒì¼ ê²½ë¡œ (ë°˜ë“œì‹œ ì‹¤ì œ íŒŒì¼ ê²½ë¡œë¡œ!)
        let isPlaying = false;
        let soundEnabled = true; // ğŸ”Š ì†Œë¦¬ ì•Œë¦¼ í™œì„±í™” ìƒíƒœ
        let session;
        const cigaretteClassId = 0; // ğŸš¬ 'cigarette' í´ë˜ìŠ¤ ID (ëª¨ë¸ í›ˆë ¨ ì‹œ ì‚¬ìš©í•œ ë ˆì´ë¸” IDë¡œ ë³€ê²½!)


        // --- HTML ìš”ì†Œ ---
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const logElement = document.getElementById('log');
        const toggleSoundButton = document.getElementById('toggleSound');

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        toggleSoundButton.addEventListener('click', toggleSoundAlert);

        // --- í•¨ìˆ˜ ---

        // ğŸ”ˆ ì†Œë¦¬ ì•Œë¦¼ í† ê¸€
        function toggleSoundAlert() {
            soundEnabled = !soundEnabled;
            toggleSoundButton.textContent = soundEnabled ? 'ì†Œë¦¬ ì•Œë¦¼ ë„ê¸°' : 'ì†Œë¦¬ ì•Œë¦¼ ì¼œê¸°';
            if (!soundEnabled && isPlaying) {
                stopSound();
            }
            logMessage(soundEnabled ? "ğŸ”Š ì†Œë¦¬ ì•Œë¦¼ ì¼œì§" : "ğŸ”‡ ì†Œë¦¬ ì•Œë¦¼ êº¼ì§");
        }

        // ğŸ“¹ ì›¹ìº  ì´ˆê¸°í™”
        async function initWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    logMessage("ğŸ“¹ ì›¹ìº  ì¤€ë¹„ ì™„ë£Œ.");
                };
            } catch (error) {
                console.error('ì›¹ìº  ì ‘ê·¼ ì˜¤ë¥˜:', error);
                logMessage(`âŒ ì›¹ìº  ì ‘ê·¼ ì˜¤ë¥˜: ${error}`);
            }
        }

        // ğŸ§  ëª¨ë¸ ë¡œë“œ
        async function loadModel() {
            try {
                session = await ort.InferenceSession.create('best.onnx'); // ğŸš€ ëª¨ë¸ íŒŒì¼ ê²½ë¡œ (ë°˜ë“œì‹œ ì‹¤ì œ ê²½ë¡œë¡œ!)
                logMessage("ğŸ§  ëª¨ë¸ ë¡œë“œ ì™„ë£Œ.");
                startDetection(); // ëª¨ë¸ ë¡œë“œ í›„ íƒì§€ ì‹œì‘
            } catch (err) {
                console.error("ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:", err);
                logMessage(`âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: ${err}`);
            }
        }


        // ğŸ–¼ï¸ ì´ë¯¸ì§€ ì „ì²˜ë¦¬ (YOLOv8 ì…ë ¥ í˜•ì‹ì— ë§ê²Œ)
       function preprocessImage(img) {
            const canvas = document.createElement('canvas'); // ì„ì‹œ ìº”ë²„ìŠ¤
            canvas.width = 640;
            canvas.height = 640;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, 640, 640); // 640x640ìœ¼ë¡œ ë¦¬ì‚¬ì´ì§•
            const imageData = ctx.getImageData(0, 0, 640, 640);
            const data = imageData.data;

            // RGB ë°ì´í„°ë¥¼ [1, 3, 640, 640] í˜•íƒœì˜ Float32Arrayë¡œ ë³€í™˜
            const inputData = new Float32Array(3 * 640 * 640);
            for (let y = 0; y < 640; y++) {
                for (let x = 0; x < 640; x++) {
                    const offset = (y * 640 + x) * 4;
                    // (R, G, B) -> (0, 1, 2)
                    inputData[y * 640 + x] = data[offset] / 255;         // R
                    inputData[640 * 640 + y * 640 + x] = data[offset + 1] / 255; // G
                    inputData[2 * 640 * 640 + y * 640 + x] = data[offset + 2] / 255; // B
                }
            }

            return new ort.Tensor('float32', inputData, [1, 3, 640, 640]);
        }


        // ğŸ¯ ê°ì²´ íƒì§€ ì‹œì‘
        async function startDetection() {
            if (!session) {
                console.error("ì„¸ì…˜ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                logMessage("âŒ ì„¸ì…˜ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            async function detectFrame() {
                // 1. ì „ì²˜ë¦¬
                const tensor = preprocessImage(video);
                const feeds = { 'images': tensor };  // ğŸ–¼ï¸ ëª¨ë¸ ì…ë ¥ ì´ë¦„ (ëª¨ë¸ì— ë”°ë¼ ë‹¤ë¦„!)

                // 2. ì¶”ë¡  ì‹¤í–‰
                try {
                    const results = await session.run(feeds);

                    // 3. í›„ì²˜ë¦¬ ë° ê²°ê³¼ ì‹œê°í™”
                    postprocessAndDraw(results, video.videoWidth, video.videoHeight); // âœ¨

                } catch (error) {
                    console.error("ì¶”ë¡  ì˜¤ë¥˜:", error);
                    logMessage(`âŒ ì¶”ë¡  ì˜¤ë¥˜: ${error}`);
                }

                // ë‹¤ìŒ í”„ë ˆì„ ì²˜ë¦¬
                requestAnimationFrame(detectFrame);
            }

            detectFrame(); // ì²« ë²ˆì§¸ í”„ë ˆì„ ì²˜ë¦¬ ì‹œì‘
        }

        // ğŸ”„ xywhë¥¼ xyxyë¡œ ë³€í™˜
        function xywh2xyxy(x, y, w, h) {
            return [x - w / 2, y - h / 2, x + w / 2, y + h / 2];
        }

        // ğŸ§¹ NMS (Non-Maximum Suppression)
        function nonMaxSuppression(boxes, scores, iouThreshold) {
            // 1. boxesì™€ scoresë¥¼ ê²°í•©í•˜ê³ , scores ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            const candidates = boxes.map((box, i) => [...box, scores[i]]).sort((a, b) => b[4] - a[4]);
            const keep = [];

            while (candidates.length > 0) {
                const current = candidates.shift(); // ê°€ì¥ ë†’ì€ score
                keep.push(current);

                // 2. IoU ê³„ì‚° ë° ì„ê³„ê°’ ì´í•˜ ì œê±°
                for (let i = candidates.length - 1; i >= 0; i--) {
                    const box = candidates[i];
                    const [x1, y1, x2, y2] = current;
                    const [x1b, y1b, x2b, y2b] = box;

                    // êµì§‘í•© ì˜ì—­ ê³„ì‚°
                    const xx1 = Math.max(x1, x1b);
                    const yy1 = Math.max(y1, y1b);
                    const xx2 = Math.min(x2, x2b);
                    const yy2 = Math.min(y2, y2b);
                    const w = Math.max(0, xx2 - xx1);
                    const h = Math.max(0, yy2 - yy1);
                    const intersection = w * h;

                    // í•©ì§‘í•© ì˜ì—­ ê³„ì‚°
                    const area1 = (x2 - x1) * (y2 - y1);
                    const area2 = (x2b - x1b) * (y2b - y1b);
                    const union = area1 + area2 - intersection;

                    const iou = intersection / union;
                    if (iou > iouThreshold) {
                        candidates.splice(i, 1); // IoUê°€ ì„ê³„ê°’ë³´ë‹¤ í¬ë©´ ì œê±°
                    }
                }
            }
            return keep; // ìµœì¢… boxes ë°˜í™˜
        }


        // ğŸ“Š ê²°ê³¼ í›„ì²˜ë¦¬, NMS, ë° ê·¸ë¦¬ê¸°
        function postprocessAndDraw(output, originalWidth, originalHeight) {
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height); // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”

            let cigaretteDetected = false;

            // ğŸ” ëª¨ë¸ ì¶œë ¥ í™•ì¸ (Netron ë“±ìœ¼ë¡œ í™•ì¸)
            // console.log(output);
            const outputName = session.outputNames[0]; // ì²« ë²ˆì§¸ ì¶œë ¥ ì´ë¦„
            const outputData = output[outputName].data;
            const rows = output[outputName].dims[1];
            const cols = output[outputName].dims[2];
            //console.log(output[outputName].dims)
            const boxes = [];
            const scores = [];
            const classIds = [];

            // YOLOv8 ì¶œë ¥ íŒŒì‹± (ì¼ë°˜ì ì¸ ê²½ìš°)
            for (let i = 0; i < rows; i++) {
                const offset = i * cols;
                const confidence = outputData[offset + 4]; // ì‹ ë¢°ë„

                if (confidence > 0.5) { // ğŸ” ì‹ ë¢°ë„ í•„í„°ë§
                    let maxClassScore = 0;
                    let classId = -1;

                    // í´ë˜ìŠ¤ í™•ë¥  ì¤‘ ê°€ì¥ ë†’ì€ ê°’ê³¼ ì¸ë±ìŠ¤ ì°¾ê¸°
                    for (let j = 5; j < cols; j++) {
                        const score = outputData[offset + j];
                        if (score > maxClassScore) {
                            maxClassScore = score;
                            classId = j - 5; // í´ë˜ìŠ¤ ID ê³„ì‚°
                        }
                    }
                    //console.log(classId)
                    // ğŸš¬ ë‹´ë°° í´ë˜ìŠ¤ ID í™•ì¸
                    if (classId === cigaretteClassId) {
                        const x = outputData[offset + 0]; // x
                        const y = outputData[offset + 1]; // y
                        const w = outputData[offset + 2]; // width
                        const h = outputData[offset + 3]; // height

                        const [x1, y1, x2, y2] = xywh2xyxy(x, y, w, h); // xywh -> xyxy

                        // ìŠ¤ì¼€ì¼ë§ (ì •ê·œí™” í•´ì œ)
                        boxes.push([
                            x1 * originalWidth,
                            y1 * originalHeight,
                            x2 * originalWidth,
                            y2 * originalHeight,
                        ]);
                        scores.push(confidence);
                        classIds.push(classId);
                    }
                }
            }

            // âœ¨ NMS ì ìš©
            const nmsResult = nonMaxSuppression(boxes, scores, 0.45); // IoU ì„ê³„ê°’ 0.45

            nmsResult.forEach(result => {
                const [x1, y1, x2, y2, score] = result;
                const label = "ğŸš¬ ë‹´ë°°"; // í´ë˜ìŠ¤ ì´ë¦„
                drawBoundingBox(x1, y1, x2 - x1, y2 - y1, score, label); // ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
                cigaretteDetected = true;
            });

            // ğŸ”Š ì†Œë¦¬ ì•Œë¦¼ ì²˜ë¦¬
            if (cigaretteDetected && !isPlaying && soundEnabled) {
                playSound();
                logMessage("ğŸš¬ ë‹´ë°° ê°ì§€! ğŸš­ ê²½ê³ !");
            } else if (!cigaretteDetected && isPlaying) {
                stopSound();
                logMessage("ğŸ‘€ ê°ì‹œ ì¤‘...");
            }
        }


        // ğŸ¨ ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
        function drawBoundingBox(x, y, width, height, confidence, label) {
            ctx.beginPath();
            ctx.rect(x, y, width, height);
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'red'; // ğŸŸ¥ ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬
            ctx.fillStyle = 'rgba(255, 0, 0, 0.2)'; //  à¦¹à¦¾à¦²à¦•à¦¾ ë¹¨ê°„ìƒ‰ ì±„ìš°ê¸° (íˆ¬ëª…ë„ 0.2)
            ctx.stroke();
            ctx.fill();


            ctx.font = '16px Arial';
            ctx.fillStyle = 'red'; // ğŸŸ¥ ë¹¨ê°„ìƒ‰ í…ìŠ¤íŠ¸
            ctx.fillText(`${label} ${confidence.toFixed(2)}`, x, y - 5); // í…ìŠ¤íŠ¸ ìœ„ì¹˜ ì¡°ì •
        }


        // ğŸ”Š ì†Œë¦¬ ì¬ìƒ
        function playSound() {
            alertSound.play().then(() => {
                isPlaying = true;
              }).catch(error => {
                console.error("ì†Œë¦¬ ì¬ìƒ ì˜¤ë¥˜:", error);
                logMessage(`âŒ ì†Œë¦¬ ì¬ìƒ ì˜¤ë¥˜: ${error}`);
                isPlaying = false; // ì—ëŸ¬ ë°œìƒ ì‹œ isPlayingì„ falseë¡œ
            });
            alertSound.loop = true;

        }

        // ğŸ”‡ ì†Œë¦¬ ì •ì§€
        function stopSound() {
            alertSound.pause();
            alertSound.currentTime = 0; // ğŸ”„ ì¬ìƒ ìœ„ì¹˜ ì´ˆê¸°í™”
            isPlaying = false;
        }

        // ğŸ“ ë¡œê·¸ ë©”ì‹œì§€
        function logMessage(message) {
            const newLog = document.createElement('div');
            newLog.textContent = message;
            logElement.appendChild(newLog);
            logElement.scrollTop = logElement.scrollHeight; // ğŸ“œ ìë™ ìŠ¤í¬ë¡¤
        }

        // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ ---
        window.onload = () => {
            logMessage("ğŸš€ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. ì´ˆê¸°í™” ì‹œì‘...");
            initWebcam();
            if (typeof ort !== 'undefined') {
                loadModel();
            } else {
                console.error("onnxruntime-web ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨");
                logMessage("âŒ onnxruntime-web ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨");
            }
        };
    </script>
</body>
</html>
